<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Create you own conference system. Part - 1</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="../css/style.css" rel="stylesheet">
</head>

<body>
<div class="header container h-100">
    <div class="row h-100 justify-content-center align-items-center">
        <div class="col-md-6 order-1 order-md-2 cv-image">
            <img src="../img/vbondariuk.jpg" alt="Vladimir Bondariuk" height="140">
        </div>
        <div class="col-md-6 order-2 order-md-1">
            <h2>Bondariuk Vladimir</h2>
            <p>Software Engineer | C# developer</p>
        </div>
    </div>
    <hr/>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Create your own conference system</h1>
            <br/>
            <p>The main goal of this article is to show how you can create you own conference system. This system will
                allow us to chat and Audio/Video calls.
            </p>
            <p> The source you can find here: <a href="https://github.com/vbondaryuk/ConferenceSystem">https://github.com/vbondaryuk/ConferenceSystem</a>
            </p>
            <p>
                For creating our system we will use follow technologies. Asp.Net Core 2.2 and Angular 7, for real-time
                communication we will use <a href="https://dotnet.microsoft.com/apps/aspnet/real-time">SignalR</a>,
                for supporting Audio/Video calls <a href="https://dotnet.microsoft.com/apps/aspnet/real-time">WebRTC</a>,
                for authentication between them JWT.
            </p>
            <p>
                Since article will have a lot of piece of codes I decided to split it to following parts
            </p>
            <ul>
                <li><a href="#create-simple-chat">Creating simple chat via SignalR</a>
                    <ul>
                        <li><a href="#create-net-core-app">Create and configure Asp .Net Core Web application</a></li>
                        <li>Create Angular application</li>
                        <li>Add chat simple implementation</li>
                        <li>Add JWT authentication</li>
                    </ul>
                </li>
                <li>
                    Add possibilities to use calls via WebRTC;
                </li>
            </ul>
            So, lets go to implementation.
            </p>
            <hr/>
            <br/>
            <div id="create-simple-chat">
                <h2>Creating simple chat via SignalR</h2>
                <p>
                    First of all we should think about project's folder structure. I will show you my view to it:
                </p>
                <div class="folder-structure">
                    <ul>
                        <li>ConferenceSystem
                            <ul>
                                <li>src
                                    <ul>
                                        <li>ConferenceSystem.Api</li>
                                        <li>ConferenceSystem-Angular</li>
                                        <li>ConferenceSystem-React(it was not of this article, but who knows me be in
                                            the future)
                                        </li>
                                    </ul>
                                </li>
                                <li>tests</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            <div id="create-net-core-app">
                <h3>Create and configure Asp .Net Core Web application</h3>
                <p>Lets start from creating .Net Core Web application. It is very easy just follow steps bellow.</p>
                <ul>
                    <li>Open Visual Studio</li>
                    <li>Create new project and call it ConferenceSystem.Api</li>
                    <li>Web\Asp .net core web application</li>
                    <li>Type the name of our system: ConferenceSystem.Api. Don't forget follow the structure I mentioned
                        above
                    </li>
                    <li>Choose net core 2.2 and empty application, with No Authentication</li>
                </ul>
                <img src="img/NewAspCoreWebApp.png" alt="New Empty asp.net core web app" height="500">
                <p>After this steps empty application will be created by Visual Studio</p>
                <h6>.Net Core and JWT Authentication</h6>
                <p>For supporting JWT authentication in .Net Core, we should modify <code>Startup</code> class. But
                    firstly we need to add configuration to <code>appsettings.json</code></p>
                <script src="https://gist.github.com/vbondaryuk/5d44b39ca24b3d40c6e0b5f25aebc8a8.js"></script>
                <p>Code explanation</p>
                <ul>
                    <li><code>SecurityKey</code> - this key need to encrypt you JWT</li>
                    <li><code>Issuer</code> - is the server that create the token</li>
                    <li><code>Audience</code> - token receipt</li>
                    <li>Last two fields it is an expiration time</li>
                </ul>
                <p>For simplifying to work with this setting we can add <code>JWTSettings</code> class.</p>
                <script src="https://gist.github.com/vbondaryuk/94be6d5c753ecfd3409ccbb6875d3910.js"></script>
                <p>Lets take a look <code>Startup</code> class and <code>ConfigureServices</code> method</p>
                <script src="https://gist.github.com/vbondaryuk/e0384e30c5bd6b4f57c39f62d4e6b975.js"></script>
                <p>Here you can see how we extract <code>JWT</code> configuration section and deserialize it to <code>JwtSettings</code> class.
                    Then we add <code>Authentication</code> service and <code>JwtBearer</code> service. In <code>JwtBearer</code> we configure <code>TokenValidationParameters</code>
                    accordingly settings from configuration and add <code>AuthenticationFailed</code> 'interceptor' where we validate is exception <code>SecurityTokenExpiredException</code>
                    and if yes add Token-Expired header. Token-Expired header allow us to add refresh token support.
                    <br/>
                    Sice we will use external client and its application will use other IP address we have to configure <code>CROS</code> policy.
                    From <a href="https://docs.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-2.2">msdn</a>:
                    Using CORS, a server can explicitly allow some cross-origin requests while rejecting others.
                </p>
                <p>For turn on our modification we should add <code>Authentication</code> and <code>CORS</code> middleware</p>
                <script src="https://gist.github.com/vbondaryuk/07665294ba449505266389f9282c4482.js"></script>
                <p>Excellent, we configured our application for supporting JWT authentication, so lets dive more deeply and add create full infrastructure for Authentication.</p>
                <h6>Add secure Api endpoint</h6>
                <p>I won't to use default <code>UserManager</code> for implementing authentication managing it is not interesting, more exciting to create it from scratch,
                    probably it won't have all possibilities, but for our system, its more than enough.</p>
                <p>For working with authenticated user we add <code>User</code>class</p>
                <script src="https://gist.github.com/vbondaryuk/a6e858ed37ff1f424b60c0e633c93280.js"></script>
                <p>Then for handling users we need to add service <code>UserService</code> this service will responsible for creating users, validating password and etc.</p>
                <script src="https://gist.github.com/vbondaryuk/b776fb21d3ef5e9dbd7d188c490168fc.js"></script>
                <p>Code explanation</p>
                <p>In current step we won't to add data base support and will use List for keeping users. <code>CreateUserDto</code> just DTO for creating user.
                    Pay attention to <code>CreateSalt</code> and <code>CreatePassword</code> methods.
                Us you can see every user has its own salt and we should not keep 'clean' password we should keep password's hash</p>
                <p>On the next step we need to add some classes and <code>TokenService</code> this service will accountable to create JWT tokens.
                    Firstly take a look across the code and bellow you will find explanation</p>
                <script src="https://gist.github.com/vbondaryuk/37751b5fc0e95f299a02982a46b484e1.js"></script>
                <p>Code explanation</p>
                <ul>
                    <li><code>JwtToken</code> - represent class which will transferred to client</li>
                    <li><code>JwtRefreshToken</code> - keep some information for validating refresh token, this class will be kept inside DataBase/InMemoryDataBase, for client should be send only refresh token value</li>
                    <li><code>TokenService</code> - are further explained bellow</li>
                </ul>

            </div>

        </div>
    </div>
    <hr/>
</div>
</body>
</html>